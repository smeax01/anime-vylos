---
import Layout from "../../layouts/Layout.astro";
import { getAnimeById } from "../../lib/anilist";
import { ArrowLeft, Play, Tv, Layers, Info, AlertTriangle } from "lucide-astro";

export const prerender = false;

const { id } = Astro.params;
const animeId = Number(id);

let anime = null;
try {
  anime = await getAnimeById(animeId);
} catch (e) {}

if (!anime) return Astro.redirect("/404");

const title = anime.title.romaji || anime.title.english;
const cover = anime.bannerImage || anime.coverImage.extraLarge;
---

<Layout title={title}>
  <div class="vylos-stream-page">
    <div class="stream-nav">
      <a href="/" class="circle-back"><ArrowLeft size={24} /></a>
      <div class="anime-mini-info">
        <span class="mini-title">{title}</span>
        <span class="mini-status" id="mini-ep-display"
          >Saison 1 • Épisode 1</span
        >
      </div>
    </div>

    <!-- PLAYER SECTION (ANIME-SAMA STYLE) -->
    <div class="main-player-section">
      <div class="player-viewport">
        <!-- Overlay de démarrage -->
        <div id="player-loading" class="player-overlay">
          <div class="vylos-loader"></div>
          <p id="status-text">Récupération des lecteurs Anime-Sama...</p>
        </div>

        <iframe
          id="content-frame"
          class="stream-iframe"
          src="about:blank"
          allowfullscreen
          allow="autoplay; encrypted-media"
        >
        </iframe>
      </div>

      <!-- CHOIX DU LECTEUR (SIBNET, ETC) -->
      <div class="player-toolbar">
        <div class="server-selector">
          <span class="toolbar-label">SOURCES DISPONIBLES :</span>
          <div class="server-chips" id="as-servers">
            <!-- Injecté par JS -->
          </div>
        </div>
        <div class="player-actions">
          <button class="action-btn" id="reload-player">Réessayer</button>
        </div>
      </div>
    </div>

    <div class="container stream-content">
      <div class="content-header">
        <h1 class="anime-title">{title}</h1>
        <div class="badges">
          <span class="badge score"
            >★ {anime.averageScore ? anime.averageScore / 10 : "?"}</span
          >
          <span class="badge lang">VOSTFR / VF</span>
        </div>
      </div>

      <div class="stream-grid">
        <div class="episodes-column">
          <h3 class="section-title"><Tv size={20} /> Épisodes</h3>
          <div class="ep-selector-grid" id="ep-list">
            <!-- Injecté par JS -->
          </div>
          <div id="no-ep-warning" class="hidden error-box">
            <AlertTriangle size={20} />
            <span>Aucun épisode trouvé sur Anime-Sama pour ce titre.</span>
          </div>
        </div>

        <div class="details-column">
          <h3 class="section-title"><Info size={20} /> Synopsis</h3>
          <p class="description" set:html={anime.description} />

          {
            anime.relations?.edges?.length > 0 && (
              <div class="seasons-area">
                <h3 class="section-title">Autres Saisons</h3>
                <div class="seasons-stack">
                  {anime.relations.edges
                    .filter((e) => e.node.type === "ANIME")
                    .map((rel) => (
                      <a href={`/anime/${rel.node.id}`} class="season-link">
                        <img src={rel.node.coverImage.medium} alt="" />
                        <div class="season-info">
                          <span class="rel-tag">{rel.relationType}</span>
                          <span class="rel-name">{rel.node.title.romaji}</span>
                        </div>
                      </a>
                    ))}
                </div>
              </div>
            )
          }
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const frame = document.getElementById("content-frame") as HTMLIFrameElement;
  const loader = document.getElementById("player-loading");
  const statusText = document.getElementById("status-text");
  const epList = document.getElementById("ep-list");
  const serverBox = document.getElementById("as-servers");
  const miniEp = document.getElementById("mini-ep-display");
  const warning = document.getElementById("no-ep-warning");

  const animeTitle = "{title}";

  let currentSources: any = {};
  let currentEp = 1;
  let activeServer = "eps1";

  // Slugify for Anime-Sama
  function slugify(text: string) {
    return text
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // remove accents
      .replace(/[^a-z0-9]/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
  }

  async function init() {
    const slug = slugify(animeTitle);
    try {
      const res = await fetch(`/api/as-source?slug=${slug}`);
      const data = await res.json();

      if (data.sources && Object.keys(data.sources).length > 0) {
        currentSources = data.sources;
        // Pick first server that has data
        activeServer = Object.keys(currentSources)[0];
        renderServers();
        renderEpisodes();
        loadVideo(1);
      } else {
        throw new Error();
      }
    } catch (e) {
      statusText!.innerText = "Erreur : Anime introuvable sur Anime-Sama.";
      warning!.classList.remove("hidden");
    }
  }

  function renderServers() {
    serverBox!.innerHTML = "";
    Object.keys(currentSources)
      .sort()
      .forEach((key) => {
        const nameMap: any = {
          eps1: "Lecteur 1",
          eps2: "Lecteur 2",
          eps3: "Sibnet",
          eps4: "Sendvid",
        };
        const btn = document.createElement("button");
        btn.className = `chip ${key === activeServer ? "active" : ""}`;
        btn.innerText = nameMap[key] || key;
        btn.onclick = () => {
          activeServer = key;
          renderServers();
          loadVideo(currentEp);
        };
        serverBox!.appendChild(btn);
      });
  }

  function renderEpisodes() {
    epList!.innerHTML = "";
    const epCount = currentSources[activeServer].length;
    for (let i = 1; i <= epCount; i++) {
      const btn = document.createElement("button");
      btn.className = `ep-chip ${i === currentEp ? "active" : ""}`;
      btn.innerText = i;
      btn.onclick = () => {
        currentEp = i;
        document
          .querySelectorAll(".ep-chip")
          .forEach((c) => c.classList.remove("active"));
        btn.classList.add("active");
        loadVideo(i);
      };
      epList!.appendChild(btn);
    }
  }

  function loadVideo(num: number) {
    currentEp = num;
    miniEp!.innerText = `Saison 1 • Épisode ${num}`;
    loader!.style.display = "flex";

    const url = currentSources[activeServer][num - 1];
    if (url) {
      frame.src = url;
      // Wait for iframe to load (approx)
      setTimeout(() => {
        loader!.style.display = "none";
      }, 1500);
    } else {
      statusText!.innerText = "Épisode non disponible sur ce lecteur.";
    }
  }

  document.getElementById("reload-player")!.onclick = () =>
    loadVideo(currentEp);

  init();
</script>

<style>
  .hidden {
    display: none !important;
  }
  .vylos-stream-page {
    min-height: 100vh;
    background: #020617;
  }

  .stream-nav {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    padding: 1rem;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 1rem;
    background: linear-gradient(to bottom, rgba(2, 6, 23, 0.9), transparent);
  }
  .circle-back {
    width: 40px;
    height: 40px;
    background: rgba(59, 130, 246, 0.2);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    backdrop-filter: blur(10px);
  }

  .anime-mini-info {
    display: flex;
    flex-direction: column;
  }
  .mini-title {
    font-weight: 800;
    color: white;
    font-size: 0.9rem;
  }
  .mini-status {
    font-size: 0.7rem;
    color: var(--color-primary);
    font-weight: 700;
    text-transform: uppercase;
  }

  .main-player-section {
    background: #000;
    padding-top: 60px;
  }
  .player-viewport {
    width: 100%;
    aspect-ratio: 16/9;
    max-width: 1280px;
    margin: 0 auto;
    position: relative;
    background: #000;
    box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
  }
  .stream-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .player-overlay {
    position: absolute;
    inset: 0;
    background: #000;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    color: white;
  }
  .vylos-loader {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(59, 130, 246, 0.1);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .player-toolbar {
    max-width: 1280px;
    margin: 0 auto;
    background: #0f172a;
    padding: 0.75rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  .server-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .toolbar-label {
    font-size: 0.65rem;
    font-weight: 900;
    color: #64748b;
    text-transform: uppercase;
  }
  .server-chips {
    display: flex;
    gap: 0.5rem;
  }
  .chip {
    background: #1e293b;
    color: #94a3b8;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 800;
    cursor: pointer;
    transition: 0.2s;
  }
  .chip.active {
    background: var(--color-primary);
    color: white;
  }
  .action-btn {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #64748b;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.7rem;
    cursor: pointer;
  }

  .stream-content {
    padding-top: 3rem;
  }
  .anime-title {
    font-size: 2.2rem;
    font-weight: 900;
    margin-bottom: 1rem;
    color: white;
  }
  .badges {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }
  .badge {
    padding: 4px 12px;
    background: #1e293b;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 700;
    color: #94a3b8;
  }
  .score {
    color: #fbbf24;
    background: rgba(251, 191, 36, 0.1);
  }

  .stream-grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 3rem;
  }
  @media (max-width: 1024px) {
    .stream-grid {
      grid-template-columns: 1fr;
    }
  }

  .section-title {
    font-size: 1.1rem;
    font-weight: 900;
    color: white;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-transform: uppercase;
  }

  .ep-selector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 8px;
  }
  .ep-chip {
    aspect-ratio: 1;
    background: #1e293b;
    border: 1px solid rgba(255, 255, 255, 0.05);
    color: white;
    border-radius: 6px;
    font-weight: 900;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .ep-chip:hover {
    border-color: var(--color-primary);
  }
  .ep-chip.active {
    background: var(--color-primary);
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
  }

  .description {
    color: #94a3b8;
    line-height: 1.7;
    font-size: 0.95rem;
    margin-bottom: 3rem;
  }
  .error-box {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    padding: 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
  }

  .seasons-stack {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .season-link {
    display: flex;
    gap: 1rem;
    text-decoration: none;
    background: #0f172a;
    padding: 0.5rem;
    border-radius: 8px;
    border: 1px solid transparent;
    transition: 0.2s;
  }
  .season-link:hover {
    border-color: var(--color-primary);
  }
  .season-link img {
    width: 50px;
    height: 70px;
    object-fit: cover;
    border-radius: 4px;
  }
  .rel-tag {
    font-size: 0.6rem;
    color: var(--color-primary);
    font-weight: 900;
    text-transform: uppercase;
    display: block;
  }
  .rel-name {
    font-size: 0.8rem;
    color: white;
    font-weight: 600;
  }
</style>
