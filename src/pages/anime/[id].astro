---
import Layout from "../../layouts/Layout.astro";
import { getAnimeById } from "../../lib/anilist";
import { ArrowLeft, Play, Layers, Tv } from "lucide-astro";

export const prerender = false;

const { id } = Astro.params;
const animeId = Number(id);

let anime = null;
try {
  anime = await getAnimeById(animeId);
} catch (e) {}

if (!anime) return Astro.redirect("/404");

const title = anime.title.romaji || anime.title.english;
const relations =
  anime.relations?.edges?.filter((e) => e.node.type === "ANIME") || [];
const cover = anime.bannerImage || anime.coverImage.extraLarge;
---

<Layout title={title}>
  <div class="player-page">
    <div class="top-nav">
      <a href="/" class="back-btn"><ArrowLeft size={24} /></a>
      <span class="nav-title">{title}</span>
    </div>

    <!-- ZONE DU LECTEUR -->
    <div class="video-wrapper-global">
      <div class="video-container" id="main-player-container">
        <!-- Placeholder avec bouton Play -->
        <div
          id="player-placeholder"
          class="placeholder"
          style={`background-image: url(${cover})`}
        >
          <div id="loader" class="hidden">
            <div class="spinner"></div>
            <p>Récupération de la vidéo...</p>
          </div>
          <button id="big-play-btn" class="big-play-btn">
            <Play size={48} fill="currentColor" />
            <span>REGARDER MAINTENANT</span>
          </button>
        </div>

        <!-- L'IFRAME qui contiendra le lecteur "aspiré" -->
        <iframe
          id="external-player"
          class="hidden"
          frameborder="0"
          allowfullscreen
          allow="autoplay; encrypted-media"
        >
        </iframe>
      </div>

      <!-- SÉLECTEUR DE SERVEURS (Comme sur Anime-Sama) -->
      <div class="player-controls hidden" id="player-controls">
        <div class="now-playing">
          <Tv size={18} />
          <span id="current-ep-label">Épisode 1</span>
        </div>
        <div class="server-list">
          <button class="server-opt active" data-src="primary"
            >Serveur Principal</button
          >
          <button class="server-opt" data-src="backup">Serveur Ultra</button>
          <button class="server-opt" data-src="embed">Serveur Multi</button>
        </div>
      </div>
    </div>

    <div class="container content-grid">
      <div class="info-block">
        <h1 class="anime-title">{title}</h1>
        <div class="tags">
          <span class="tag score"
            >★ {anime.averageScore ? anime.averageScore / 10 : "?"}</span
          >
          <span class="tag status">{anime.status}</span>
          <span class="tag count">{anime.episodes || "?"} Épisodes</span>
        </div>
        <p class="desc" set:html={anime.description} />
      </div>

      <!-- NAVIGATION SAISONS -->
      {
        relations.length > 0 && (
          <div class="seasons-box">
            <h3 class="box-title">
              <Layers size={20} /> Saisons & Suites
            </h3>
            <div class="seasons-list">
              {relations.map((rel) => (
                <a href={`/anime/${rel.node.id}`} class="season-item">
                  <img src={rel.node.coverImage.medium} alt="" />
                  <div class="season-meta">
                    <span class="rel-type">{rel.relationType}</span>
                    <span class="rel-name">{rel.node.title.romaji}</span>
                  </div>
                </a>
              ))}
            </div>
          </div>
        )
      }

      <!-- LISTE DES ÉPISODES -->
      <div class="episodes-box">
        <h3 class="box-title">Liste des Épisodes</h3>
        <div id="ep-grid" class="ep-grid">
          <div class="ep-loading">Chargement des épisodes...</div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const placeholder = document.getElementById("player-placeholder");
  const loader = document.getElementById("loader");
  const bigPlayBtn = document.getElementById("big-play-btn");
  const iframe = document.getElementById(
    "external-player"
  ) as HTMLIFrameElement;
  const epGrid = document.getElementById("ep-grid");
  const controls = document.getElementById("player-controls");
  const epLabel = document.getElementById("current-ep-label");
  const serverBtns = document.querySelectorAll(".server-opt");

  const animeId = "{anime.id}";
  const animeTitle = "{title}";
  const totalEpisodes = Number("{anime.episodes || 12}");

  let episodesData: any[] = [];
  let currentEpNum = 1;
  let currentProvider = "primary";

  // 1. Charger la liste des épisodes depuis une API stable
  async function init() {
    try {
      const res = await fetch(
        `https://api-consumet.vercel.app/meta/anilist/info/${animeId}`
      );
      const data = await res.json();
      if (data.episodes && data.episodes.length > 0) {
        episodesData = data.episodes;
      } else {
        generateManualList();
      }
    } catch (e) {
      generateManualList();
    }
    renderEpisodes();
  }

  function generateManualList() {
    for (let i = 1; i <= totalEpisodes; i++) {
      episodesData.push({
        id: `manual-${i}`,
        number: i,
        title: `Épisode ${i}`,
      });
    }
  }

  function renderEpisodes() {
    epGrid!.innerHTML = "";
    episodesData.forEach((ep) => {
      const card = document.createElement("div");
      card.className = "ep-card";
      card.innerHTML = `<span class="ep-n">EP ${ep.number}</span><span class="ep-t">${ep.title || ""}</span>`;
      card.onclick = () => selectEpisode(ep);
      epGrid!.appendChild(card);
    });
    // Bouton Play principal lance le 1er
    bigPlayBtn!.onclick = () => selectEpisode(episodesData[0]);
  }

  async function selectEpisode(ep: any) {
    currentEpNum = ep.number;
    epLabel!.innerText = `Épisode ${ep.number}`;

    placeholder!.style.display = "flex";
    bigPlayBtn!.classList.add("hidden");
    loader!.classList.remove("hidden");
    iframe.classList.add("hidden");
    controls!.classList.remove("hidden");

    await loadVideo(ep);
  }

  async function loadVideo(ep: any) {
    try {
      // On cherche le lien Embed (comme Anime-Sama le fait)
      // On passe par un fournisseur de lecteurs tiers
      const slug = animeTitle.toLowerCase().replace(/[^a-z0-9]/g, "-");

      if (currentProvider === "primary") {
        // On essaye de récupérer le lecteur GogoAnime
        const res = await fetch(
          `https://api-consumet.vercel.app/anime/gogoanime/watch/${slug}-episode-${ep.number}`
        );
        const data = await res.json();
        if (data.headers?.Referer) {
          iframe.src = data.headers.Referer;
        } else {
          throw new Error();
        }
      } else {
        // Serveurs Alternatifs
        iframe.src = `https://anitaku.to/embed/${slug}-episode-${ep.number}`;
      }

      iframe.classList.remove("hidden");
      placeholder!.style.display = "none";
    } catch (e) {
      // Fallback ultime : Lecteur universel
      const slugAlt = animeTitle.toLowerCase().replace(/ /g, "-");
      iframe.src = `https://www.ducine.org/anime/${slugAlt}-episode-${ep.number}`; // Provider alternatif
      iframe.classList.remove("hidden");
      placeholder!.style.display = "none";
    } finally {
      loader!.classList.add("hidden");
    }
  }

  // Changement de serveur
  serverBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      serverBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      currentProvider = (btn as HTMLElement).dataset.src!;
      const ep = episodesData.find((e) => e.number === currentEpNum);
      loadVideo(ep);
    });
  });

  init();
</script>

<style>
  .hidden {
    display: none !important;
  }
  .player-page {
    padding-bottom: 5rem;
  }

  /* NAVBAR FIX */
  .top-nav {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    padding: 1rem;
    z-index: 50;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .back-btn {
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border-radius: 8px;
    padding: 0.5rem;
    display: flex;
    backdrop-filter: blur(5px);
  }
  .nav-title {
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
  }

  /* PLAYER AREA */
  .video-wrapper-global {
    background: #000;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    margin-bottom: 2rem;
  }
  .video-container {
    width: 100%;
    aspect-ratio: 16/9;
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    background: #000;
  }

  .placeholder {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
  .placeholder::after {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }

  #external-player {
    width: 100%;
    height: 100%;
    z-index: 5;
  }

  .big-play-btn {
    position: relative;
    z-index: 20;
    background: var(--color-primary);
    color: white;
    border: none;
    padding: 1.5rem 2rem;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    font-weight: 900;
    letter-spacing: 1px;
    transition: transform 0.2s;
    cursor: pointer;
  }
  .big-play-btn:hover {
    transform: scale(1.05);
  }

  #loader {
    position: relative;
    z-index: 20;
    color: white;
    text-align: center;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* CONTROLES */
  .player-controls {
    background: #0f172a;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  .now-playing {
    color: white;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
  }
  .server-list {
    display: flex;
    gap: 5px;
  }
  .server-opt {
    background: #1e293b;
    color: #94a3b8;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
  }
  .server-opt.active {
    background: var(--color-primary);
    color: white;
  }

  /* CONTENT */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 3rem;
    padding-top: 1rem;
  }
  @media (max-width: 900px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }

  .anime-title {
    font-size: 2.2rem;
    font-weight: 900;
    color: white;
    margin-bottom: 1rem;
  }
  .tags {
    display: flex;
    gap: 10px;
    margin-bottom: 1.5rem;
  }
  .tag {
    background: #1e293b;
    color: #94a3b8;
    padding: 4px 12px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.8rem;
  }
  .score {
    color: #fbbf24;
    background: rgba(251, 191, 36, 0.1);
  }
  .desc {
    line-height: 1.8;
    color: #cbd5e1;
    font-size: 1rem;
  }

  .box-title {
    font-size: 1.3rem;
    font-weight: 800;
    color: white;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* SEASONS */
  .seasons-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .season-item {
    display: flex;
    gap: 1rem;
    text-decoration: none;
    background: #1e293b;
    padding: 0.5rem;
    border-radius: 8px;
    border: 1px solid transparent;
    transition: 0.2s;
  }
  .season-item:hover {
    border-color: var(--color-primary);
  }
  .season-item img {
    width: 60px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
  }
  .season-meta {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .rel-type {
    font-size: 0.65rem;
    color: var(--color-primary);
    font-weight: 800;
    text-transform: uppercase;
  }
  .rel-name {
    font-size: 0.85rem;
    color: white;
    font-weight: 600;
  }

  /* EPISODES */
  .ep-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
  }
  .ep-card {
    background: #1e293b;
    color: white;
    height: 60px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: 0.2s;
  }
  .ep-card:hover {
    background: var(--color-primary);
    transform: translateY(-3px);
  }
  .ep-n {
    font-weight: 800;
    font-size: 0.9rem;
  }
  .ep-t {
    font-size: 0.6rem;
    opacity: 0.6;
    text-align: center;
    display: none;
  }
</style>
